#
# Archivo de configuracion del servicio de integraciÃ³n continua.
#
machine:
  timezone: 
    America/Bogota
  python:
    version: 2.7.11

dependencies:
  pre:
    - sudo apt-get update
    - sudo apt-get install apache2 git python python-pip libapache2-mod-wsgi libapache2-mod-python curl
    - sudo pip install --upgrade pip setuptools
    - sudo apt-get install libtiff5-dev libjpeg8-dev zlib1g-dev libfreetype6-dev liblcms2-dev libwebp-dev tcl8.6-dev tk8.6-dev python-tk
    - sudo apt-get install libxml2-dev libxslt1-dev python-dev libmysqlclient-dev
    - sudo pip install -U django requests openpyxl lxml python-pptx pyyaml decorators retrying urllib3 fluidasserts social-auth-app-django pylint pylint-django prospector mysqlclient django-sslserver
    - sudo cp -a /home/ubuntu/fluid-integrates/ /var/www/
    - cat /var/www/fluid-integrates/config/db-schema.sql | mysql -uroot -p${MYSQLPASS} -h fluidservesexams.cgsvzmr33idc.us-east-1.rds.amazonaws.com
    - sudo python /var/www/fluid-integrates/manage.py makemigrations
    - sudo python /var/www/fluid-integrates/manage.py migrate 
    - sudo chown -R www-data:www-data /var/www/fluid-integrates
    - sudo cp config/integrates-ssl.conf /etc/apache2/sites-available/integrates-ssl.conf
    - echo $VAULT > ~/.vault.txt
    - sudo cp config/fluidla.crt /etc/ssl/certs/fluidla.crt
    - sudo cp config/fluidla.key /etc/ssl/private/fluidla.key
    - ansible-vault --vault-password-file ~/.vault.txt decrypt /etc/ssl/certs/fluidla.crt
    - ansible-vault --vault-password-file ~/.vault.txt decrypt /etc/ssl/private/fluidla.key
    - sudo chmod 600 /etc/ssl/private/fluidla.key
    - sudo a2ensite integrates-ssl.conf
  post:
    - sudo service apache2 restart
test:
  override:
    - sudo python /var/www/fluid-integrates/manage.py test
    - prospector -u django app
    - prospector -u django fluidintegrates
