################################################################
#Archivo de configuracion del servicio de integraciÃ³n continua.#
################################################################
---
version: 2
jobs:
  build:
    working_directory: /tmp/fluid-integrates
    machine: true
    evironment:
      - USER: root
    steps:
      - checkout
      - run:
          name: Update
          command: sudo apt-get update
      - run:
          name: Install dependencies
          command: >
           gem install overcommit
      - run:
          name: Vault file
          command: >
              sudo echo $VAULT > ~/.vault.txt &&
              sudo echo $VAULT > /tmp/.vault.txt

      - run:
          name: pip installations
          command: >
                sudo apt-get install -y python-dev python-pip &&
                pip install --upgrade -r requirements.txt

      - run:
          name: Ansible lints
          command: >
                ansible-lint deploy/main.yml

      - run:
          name: Run Integrates tests
          command: >
                python manage.py test

      - run:
          name: Run prospector
          command: >
                prospector -u django app &&
                prospector -u django fluidintegrates &&
                prospector -u django deploy 

      - run:
          name: Run SourceClear agent
          command: >
                curl -sSL https://download.sourceclear.com/ci.sh | sh

      - run:
          name: Run settings check
          command: >
                grep ^SOCIAL_AUTH_LOGIN_REDIRECT_URL fluidintegrates/settings.py | grep -q fluid.la;
                grep ^SOCIAL_AUTH_NEW_USER_REDIRECT_URL fluidintegrates/settings.py | grep -q fluid

      - run:
          name: Docker login
          command: >
                sudo aws configure set aws_access_key_id $AWS_KEY_ID &&
                sudo aws configure set aws_secret_access_key $AWS_SECRET_KEY &&
                sudo aws ecr get-login --region us-east-1 >> login.sh && sudo sh login.sh

      - run:
          name: Build container
          command: sudo deploy/build.sh $CIRCLE_BRANCH

      - run:
          name: Run asserts
          command: python deploy/asserts-checks.py

      # Deploy master
      - deploy:
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ];
              then sudo aws configure set aws_access_key_id $AWS_KEY_ID && \
              sudo aws configure set aws_secret_access_key $AWS_SECRET_KEY && \
              sudo aws ecr get-login --region us-east-1 >> login.sh && sudo sh login.sh && \
              sudo docker -D push 205810638802.dkr.ecr.us-east-1.amazonaws.com/integrates:master;
            fi
